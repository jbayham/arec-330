<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Week 6 Lab: Forecasting National Park Visitation</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="lab_files/libs/clipboard/clipboard.min.js"></script>
<script src="lab_files/libs/quarto-html/quarto.js"></script>
<script src="lab_files/libs/quarto-html/popper.min.js"></script>
<script src="lab_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="lab_files/libs/quarto-html/anchor.min.js"></script>
<link href="lab_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="lab_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="lab_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="lab_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="lab_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<link rel="stylesheet" href="../course-links.css">
</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#learning-objectives" id="toc-learning-objectives" class="nav-link active" data-scroll-target="#learning-objectives">Learning Objectives</a></li>
  <li><a href="#lab-notebook" id="toc-lab-notebook" class="nav-link" data-scroll-target="#lab-notebook">Lab Notebook</a></li>
  <li><a href="#section-0-setup" id="toc-section-0-setup" class="nav-link" data-scroll-target="#section-0-setup">Section 0: Setup</a>
  <ul class="collapse">
  <li><a href="#download-data" id="toc-download-data" class="nav-link" data-scroll-target="#download-data">Download data</a></li>
  <li><a href="#preliminaries" id="toc-preliminaries" class="nav-link" data-scroll-target="#preliminaries">Preliminaries</a></li>
  <li><a href="#load-the-arches-monthly-visitation-data" id="toc-load-the-arches-monthly-visitation-data" class="nav-link" data-scroll-target="#load-the-arches-monthly-visitation-data">Load the Arches monthly visitation data</a></li>
  </ul></li>
  <li><a href="#section-1-make-a-time-series-object" id="toc-section-1-make-a-time-series-object" class="nav-link" data-scroll-target="#section-1-make-a-time-series-object">Section 1: Make a time series object</a>
  <ul class="collapse">
  <li><a href="#plot-the-raw-series" id="toc-plot-the-raw-series" class="nav-link" data-scroll-target="#plot-the-raw-series">Plot the raw series</a></li>
  </ul></li>
  <li><a href="#section-2-decomposition-with-stl" id="toc-section-2-decomposition-with-stl" class="nav-link" data-scroll-target="#section-2-decomposition-with-stl">Section 2: Decomposition with STL</a>
  <ul class="collapse">
  <li><a href="#the-idea-intuition-math" id="toc-the-idea-intuition-math" class="nav-link" data-scroll-target="#the-idea-intuition-math">The idea (intuition + math)</a></li>
  <li><a href="#fit-stl-decomposition" id="toc-fit-stl-decomposition" class="nav-link" data-scroll-target="#fit-stl-decomposition">Fit STL decomposition</a></li>
  <li><a href="#visualize-the-components" id="toc-visualize-the-components" class="nav-link" data-scroll-target="#visualize-the-components">Visualize the components</a></li>
  </ul></li>
  <li><a href="#section-3-seasonally-adjusted-series" id="toc-section-3-seasonally-adjusted-series" class="nav-link" data-scroll-target="#section-3-seasonally-adjusted-series">Section 3: Seasonally adjusted series</a>
  <ul class="collapse">
  <li><a href="#extract-and-plot-seasonally-adjusted-visits-series" id="toc-extract-and-plot-seasonally-adjusted-visits-series" class="nav-link" data-scroll-target="#extract-and-plot-seasonally-adjusted-visits-series">Extract and plot seasonally adjusted visits series</a></li>
  </ul></li>
  <li><a href="#section-4-forecasting-with-decomposition" id="toc-section-4-forecasting-with-decomposition" class="nav-link" data-scroll-target="#section-4-forecasting-with-decomposition">Section 4: Forecasting with decomposition</a>
  <ul class="collapse">
  <li><a href="#the-big-idea-math" id="toc-the-big-idea-math" class="nav-link" data-scroll-target="#the-big-idea-math">The big idea (math)</a></li>
  <li><a href="#traintest-split" id="toc-traintest-split" class="nav-link" data-scroll-target="#traintest-split">Train/test split</a></li>
  <li><a href="#fit-a-decomposition-based-forecasting-model-stl-naive-on-sa" id="toc-fit-a-decomposition-based-forecasting-model-stl-naive-on-sa" class="nav-link" data-scroll-target="#fit-a-decomposition-based-forecasting-model-stl-naive-on-sa">Fit a decomposition-based forecasting model (STL + Naive on SA)</a></li>
  </ul></li>
  <li><a href="#section-5-forecast-accuracy" id="toc-section-5-forecast-accuracy" class="nav-link" data-scroll-target="#section-5-forecast-accuracy">Section 5: Forecast accuracy</a></li>
  <li><a href="#section-6-compare-to-a-simple-benchmark" id="toc-section-6-compare-to-a-simple-benchmark" class="nav-link" data-scroll-target="#section-6-compare-to-a-simple-benchmark">Section 6: Compare to a simple benchmark</a></li>
  <li><a href="#section-7-replicate-the-process-for-another-park" id="toc-section-7-replicate-the-process-for-another-park" class="nav-link" data-scroll-target="#section-7-replicate-the-process-for-another-park">Section 7: Replicate the process for another park</a></li>
  <li><a href="#deliverables" id="toc-deliverables" class="nav-link" data-scroll-target="#deliverables">Deliverables</a></li>
  </ul>
</nav>
</div>
<main class="content" id="quarto-document-content">
<nav class="course-links" aria-label="Course links">
  <div class="course-links__inner">
    <div class="course-links__left">
      <a class="course-links__brand" href="https://jbayham.github.io/arec-330/">AREC 330</a>
      <span class="course-links__sep">|</span>
      <span class="course-links__page">Lab</span>
    </div>

    <div class="course-links__right">
      <a class="course-links__btn" href="https://jbayham.github.io/arec-330/">Course site</a>
      <a class="course-links__btn" href="https://colostate.instructure.com/courses/218386">Canvas</a>
    </div>
  </div>
</nav>

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Week 6 Lab: Forecasting National Park Visitation</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<p><img src="includes/lab_header.png" class="img-fluid"></p>
<p>Forecasting is about using patterns in past data to form a <em>transparent</em>, <em>testable</em> prediction about the future. In this lab, you will forecast <strong>monthly recreation visits</strong> to a U.S. National Park.</p>
<p>Each person will:</p>
<ol type="1">
<li><strong>Decompose</strong> the time series into trend, seasonal, and remainder components using <strong>STL</strong>.</li>
<li><strong>Forecast</strong> the seasonally adjusted series with a simple benchmark method.</li>
</ol>
<p>This workflow is called <strong>forecasting with decomposition</strong> and is emphasized in <em>Forecasting: Principles and Practice (3rd ed.)</em> (FPP3) <span class="citation" data-cites="hyndman2018fpp3">(<a href="#ref-hyndman2018fpp3" role="doc-biblioref">Hyndman and Athanasopoulos 2018</a>)</span>.</p>
<ul>
<li>STL decomposition overview: https://otexts.com/fpp3/stl.html</li>
<li>Forecasting with decomposition: https://otexts.com/fpp3/forecasting-decomposition.html</li>
</ul>
<section id="learning-objectives" class="level2">
<h2 class="anchored" data-anchor-id="learning-objectives">Learning Objectives</h2>
<p>By the end of the lab, you will be able to:</p>
<ul>
<li>Convert monthly data into a <code>tsibble</code> (tidy time series)</li>
<li>Use <strong>STL decomposition</strong> to separate a series into interpretable components</li>
<li>Explain what seasonal adjustment does (and why it can help forecasting)</li>
<li>Build a simple <strong>decomposition-based forecast</strong></li>
<li>Evaluate forecast accuracy using a train/test split</li>
<li>Compare forecasts to a strong benchmark (<strong>seasonal naive</strong>)</li>
</ul>
</section>
<section id="lab-notebook" class="level2">
<h2 class="anchored" data-anchor-id="lab-notebook">Lab Notebook</h2>
<p>Open up a word processing document (e.g., Google Doc, Word, or plain text) to serve as your lab notebook. Use this to respond to questions, document decisions, and reflect on the process. You should also comment your R script thoroughly to explain your code and rationale for each step.</p>
<hr>
</section>
<section id="section-0-setup" class="level1">
<h1>Section 0: Setup</h1>
<section id="download-data" class="level2">
<h2 class="anchored" data-anchor-id="download-data">Download data</h2>
<p>We will download data on monthly National Park visitation from the <a href="https://irma.nps.gov/Stats/SSRSReports/National%20Reports/Query%20Builder%20for%20Public%20Use%20Statistics%20(1979%20-%20Last%20Calendar%20Year)">Integrated Resource Management Applications (IRMA) Portal</a></p>
<p>Placeholder for video walkthrough of data download process.</p>
</section>
<section id="preliminaries" class="level2">
<h2 class="anchored" data-anchor-id="preliminaries">Preliminaries</h2>
<ol type="1">
<li>Create a folder called <code>lab_06</code>.</li>
<li>Create a new R script called <code>lab_06.R</code> in that folder.</li>
<li>Write a brief comment at the top describing the purpose of the script and your name.</li>
<li>Load required libraries at the top:</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># install.packages("fpp3")  # only if you don't have it</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(fpp3)              <span class="co"># loads tsibble, feasts, fable, etc.</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The <code>fpp3</code> package loads the toolchain used in the textbook FPP3.</p>
</section>
<section id="load-the-arches-monthly-visitation-data" class="level2">
<h2 class="anchored" data-anchor-id="load-the-arches-monthly-visitation-data">Load the Arches monthly visitation data</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>arches_raw <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"arches.csv"</span>)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(arches_raw)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The key outcome for this lab is <code>RecreationVisits</code>, monthly recreation visits (this is the standard visitation measure in NPS visitor use stats).</p>
<div class="callout-attention">
<p><strong>Question 1:</strong> What is the unit of observation in <code>arches_raw</code>? (What does one row represent?) Answer in your notebook.</p>
</div>
<hr>
</section>
</section>
<section id="section-1-make-a-time-series-object" class="level1">
<h1>Section 1: Make a time series object</h1>
<p>Time series forecasting requires a clear <strong>time index</strong>.</p>
<ul>
<li><strong>Index</strong>: time variable (year-month)</li>
</ul>
<p>First, we need to convert the raw data into a <code>tsibble</code> (tidy time series format). A <code>tsibble</code> is a data frame with special attributes that allow it to be used with time series functions in the <code>fpp3</code> ecosystem. We will create a new variable for the time index using a function from the <code>tsibble</code> package called <code>yearmonth()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>arches <span class="ot">&lt;-</span> arches_raw <span class="sc">%&gt;%</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">ymonth =</span> <span class="fu">yearmonth</span>(month)) <span class="sc">%&gt;%</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(ymonth) <span class="sc">%&gt;%</span> <span class="co">#ensure data is in chronological order</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tsibble</span>(<span class="at">index =</span> ymonth) <span class="co">#convert to tsibble with ymonth as the index</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="plot-the-raw-series" class="level2">
<h2 class="anchored" data-anchor-id="plot-the-raw-series">Plot the raw series</h2>
<p>We use the function <code>autoplot()</code> from the <code>feasts</code> package to quickly visualize the series. autoplot recognizes the time index and creates a time series plot. Technically, autoplot is a wrapper around <code>ggplot2</code> that creates a line plot of the specified variable against the time index, which means you can add layers and customize it like any ggplot.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>arches <span class="sc">%&gt;%</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">autoplot</span>(visits)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout-attention">
<p><strong>Question 2:</strong> Describe the visitation series. Do you see:</p>
<ul>
<li>long-run changes (trend / regime shifts)?</li>
<li>repeated within-year patterns (seasonality)?</li>
<li>unusual spikes (outliers)?</li>
</ul>
<p>Answer in your notebook.</p>
</div>
<hr>
</section>
</section>
<section id="section-2-decomposition-with-stl" class="level1">
<h1>Section 2: Decomposition with STL</h1>
<p>Time series often have multiple patterns at once. Decomposition is a way to separate these patterns into components that are easier to understand and forecast. Decomposition helps you visualize and understand your data, but it can also be used as part of a forecasting workflow (more on that later).</p>
<section id="the-idea-intuition-math" class="level2">
<h2 class="anchored" data-anchor-id="the-idea-intuition-math">The idea (intuition + math)</h2>
<p>A common way to represent a seasonal time series is an <strong>additive decomposition</strong>:</p>
<p><span class="math display">\[
y_t = T_t + S_t + R_t
\]</span></p>
<ul>
<li><span class="math inline">\(y_t\)</span>: observed DSCI at month <span class="math inline">\(t\)</span></li>
<li><span class="math inline">\(T_t\)</span>: trend-cycle (slow-moving component)</li>
<li><span class="math inline">\(S_t\)</span>: seasonal component (is similar each year, but is allowed to change slowly over time)</li>
<li><span class="math inline">\(R_t\)</span>: remainder (what’s left after removing trend + seasonality)</li>
</ul>
<p>STL (“Seasonal and Trend decomposition using Loess”) estimates <span class="math inline">\(T_t\)</span> and <span class="math inline">\(S_t\)</span> using flexible smoothing, and then defines the remainder as:</p>
<p><span class="math display">\[R_t = y_t - T_t - S_t\]</span></p>
<p>STL is widely used because it is flexible and can be made robust to outliers.</p>
</section>
<section id="fit-stl-decomposition" class="level2">
<h2 class="anchored" data-anchor-id="fit-stl-decomposition">Fit STL decomposition</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>fit_stl <span class="ot">&lt;-</span> arches <span class="sc">%&gt;%</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">model</span>(</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">STL</span>(visits <span class="sc">~</span> <span class="fu">trend</span>(<span class="at">window =</span> <span class="dv">13</span>), <span class="at">robust =</span> <span class="cn">TRUE</span>)</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li><code>model(STL(...))</code> estimates the decomposition components.</li>
<li><code>trend(window = 13)</code> controls how smooth the trend is (roughly: how many months the smoother uses).</li>
<li><code>robust = TRUE</code> reduces the influence of outliers on the decomposition.</li>
</ul>
</section>
<section id="visualize-the-components" class="level2">
<h2 class="anchored" data-anchor-id="visualize-the-components">Visualize the components</h2>
<p>After fitting the model, we can extract the components and plot them to understand the patterns in the data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">components</span>(fit_stl) <span class="sc">%&gt;%</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">autoplot</span>() </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout-attention">
<p><strong>Question 3:</strong> Use the decomposition plot to answer:</p>
<ol type="1">
<li><p>Is the seasonal component large relative to the trend and remainder? What does this say about the importance of seasonality at Arches National Park?</p></li>
<li><p>Which months are typically highest/lowest visitation?</p></li>
<li><p>Does the trend show multi-year growth/decline regimes?</p></li>
<li><p>Identify at least one major “shock” period (example: abrupt drops). What might explain it?</p></li>
</ol>
<p>Answer in your notebook.</p>
</div>
<hr>
</section>
</section>
<section id="section-3-seasonally-adjusted-series" class="level1">
<h1>Section 3: Seasonally adjusted series</h1>
<p>A “seasonally adjusted” series removes the repeating seasonal pattern so we can focus on the underlying movement:</p>
<p><span class="math display">\[
\text{SA}_t = y_t - S_t = T_t + R_t
\]</span></p>
<p>This is useful because many forecasting methods work better when seasonality is removed first.</p>
<section id="extract-and-plot-seasonally-adjusted-visits-series" class="level2">
<h2 class="anchored" data-anchor-id="extract-and-plot-seasonally-adjusted-visits-series">Extract and plot seasonally adjusted visits series</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>cmp <span class="ot">&lt;-</span> <span class="fu">components</span>(fit_stl)</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>cmp <span class="sc">%&gt;%</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>() <span class="sc">%&gt;%</span> <span class="co">#convert to tibble for easier manipulation</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(month, visits, season_adjust) <span class="sc">%&gt;%</span> <span class="co">#subset to original and seasonally adjusted series</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">c</span>(visits, season_adjust), <span class="co">#reshape to long format for plotting</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_to =</span> <span class="st">"series"</span>,</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>               <span class="at">values_to =</span> <span class="st">"value"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> month, <span class="at">y =</span> value)) <span class="sc">+</span> <span class="co">#passing the long format data to ggplot</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>series, <span class="at">ncol =</span> <span class="dv">1</span>, <span class="at">scales =</span> <span class="st">"free_y"</span>)  <span class="co">#facet_wrap produces different panels for each series</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout-attention">
<p><strong>Question 4:</strong> Compare the original and seasonally adjusted series. What changes? What stays the same? Answer in your notebook.</p>
</div>
<hr>
</section>
</section>
<section id="section-4-forecasting-with-decomposition" class="level1">
<h1>Section 4: Forecasting with decomposition</h1>
<section id="the-big-idea-math" class="level2">
<h2 class="anchored" data-anchor-id="the-big-idea-math">The big idea (math)</h2>
<p>We will forecast <span class="math inline">\(y_t\)</span> by forecasting its parts:</p>
<ol type="1">
<li><p>Decompose: <span class="math inline">\(y_t = T_t + S_t + R_t\)</span></p></li>
<li><p>Forecast the seasonally adjusted series: <span class="math display">\[\widehat{\text{SA}}_{t+h}\]</span></p></li>
<li><p>Forecast the seasonal component: <span class="math display">\[\widehat{S}_{t+h}\]</span></p></li>
<li><p>Re-seasonalize to get the final forecast: <span class="math display">\[\hat{y}_{t+h} = \widehat{\text{SA}}_{t+h} + \widehat{S}_{t+h}\]</span></p></li>
</ol>
<p>This is the “forecasting with decomposition” workflow in <span class="citation" data-cites="hyndman2018fpp3">Hyndman and Athanasopoulos (<a href="#ref-hyndman2018fpp3" role="doc-biblioref">2018</a>)</span> Chapter 5.7.</p>
</section>
<section id="traintest-split" class="level2">
<h2 class="anchored" data-anchor-id="traintest-split">Train/test split</h2>
<p>We have covered how we will do the forecasting. We will evaluate the forecast by comparing it to actual values that we withhold from the model. We will define a “training” dataset to estimate model parameters, then assess performance on the “test” set (the set that the model has not yet seen). This is called a <strong>train/test split</strong>.</p>
<p>We will hold out the last 24 months to test forecasting performance.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>h <span class="ot">&lt;-</span> <span class="dv">36</span> <span class="co">#forecast horizon (months to hold out)</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>last_month <span class="ot">&lt;-</span> <span class="fu">max</span>(arches<span class="sc">$</span>month) <span class="co">#define the last month in the data</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="co">#Create training and test sets based on the last month and forecast horizon</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>train <span class="ot">&lt;-</span> arches <span class="sc">%&gt;%</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(month <span class="sc">&lt;=</span> (last_month <span class="sc">-</span> h))</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>test <span class="ot">&lt;-</span> arches <span class="sc">%&gt;%</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(month <span class="sc">&gt;</span> (last_month <span class="sc">-</span> h))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="fit-a-decomposition-based-forecasting-model-stl-naive-on-sa" class="level2">
<h2 class="anchored" data-anchor-id="fit-a-decomposition-based-forecasting-model-stl-naive-on-sa">Fit a decomposition-based forecasting model (STL + Naive on SA)</h2>
<p>Here’s the key modeling step:</p>
<ul>
<li>Decompose with STL</li>
<li>Forecast the seasonally adjusted series using a simple benchmark: <strong>NAIVE</strong></li>
<li>Automatically reseasonalize the forecast</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Estimate the decomposition-based forecasting model</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>fit_dcmp <span class="ot">&lt;-</span> train <span class="sc">%&gt;%</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">model</span>(</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">stlf =</span> <span class="fu">decomposition_model</span>(</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>      <span class="fu">STL</span>(visits <span class="sc">~</span> <span class="fu">trend</span>(<span class="at">window =</span> <span class="dv">13</span>), <span class="at">robust =</span> <span class="cn">TRUE</span>),</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>      <span class="fu">ETS</span>(season_adjust)</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a><span class="co">#Use the model to forecast the next 24 months</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>fc_dcmp <span class="ot">&lt;-</span> fit_dcmp <span class="sc">%&gt;%</span></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">forecast</span>(<span class="at">h =</span> h)</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a><span class="co">#Plot the forecasts (with the test data visible)</span></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>forecast_plot <span class="ot">&lt;-</span> fc_dcmp <span class="sc">%&gt;%</span></span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">autoplot</span>(test)</span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a><span class="co">#Display the plot</span></span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>forecast_plot</span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a><span class="co">#save the plot as "forecast_plot.png" in the current working directory</span></span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a><span class="fu">ggsave</span>(<span class="st">"forecast_plot.png"</span>, <span class="at">plot =</span> forecast_plot, <span class="at">width =</span> <span class="dv">5</span>, <span class="at">height =</span> <span class="dv">5</span>, <span class="at">units =</span> <span class="st">"in"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This is similar to the approach used in <span class="citation" data-cites="hyndman2018fpp3">Hyndman and Athanasopoulos (<a href="#ref-hyndman2018fpp3" role="doc-biblioref">2018</a>)</span> for decomposition-based forecasting examples.</p>
<hr>
</section>
</section>
<section id="section-5-forecast-accuracy" class="level1">
<h1>Section 5: Forecast accuracy</h1>
<p>We care about <strong>out-of-sample</strong> accuracy: how close forecasts are to reality in the held-out test period.</p>
<p>Common metrics:</p>
<ul>
<li><strong>MAE</strong>: mean absolute error - the average size of the errors (ignoring direction)</li>
<li><strong>RMSE</strong>: root mean squared error - the square root of the average squared errors (penalizes large misses)</li>
<li><strong>MAPE</strong>: mean absolute percentage error - the average size of errors relative to actual values (can be misleading when actuals are close to zero)</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">accuracy</span>(fc_dcmp, test) <span class="sc">%&gt;%</span> <span class="co">#generates a data frame of accuracy metrics by comparing forecasts to test data</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(.model, MAE, RMSE, MAPE) <span class="co">#subsetting to just the metrics we care about</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout-attention">
<p><strong>Question 5:</strong> Report MAE and RMSE.</p>
<ul>
<li>In plain language: how good were the forecasts over the last 36 months?</li>
<li>When you look at the forecast plot, can you see any patterns in the forecast errors (too high, too low, systematic bias)?</li>
</ul>
<p>Arches NP implemented a reservation system in 2020 that may have changed visitation patterns.</p>
<ul>
<li>Do you see any evidence of this in the forecast errors?</li>
</ul>
<p>However, they just announced that the reservation system will be removed in 2026.</p>
<ul>
<li>How might you account for this in future forecasting?</li>
</ul>
<p>Answer in your notebook.</p>
</div>
<hr>
</section>
<section id="section-6-compare-to-a-simple-benchmark" class="level1">
<h1>Section 6: Compare to a simple benchmark</h1>
<p>A model should be judged against a benchmark. A natural benchmark for monthly data is <strong>seasonal naive</strong>:</p>
<p><span class="math display">\[
\hat{y}_{t+12} = y_t
\]</span></p>
<p>Meaning: “This month will look like the same month last year.” It may surprise you, but seasonal naive is often a hard forecast to beat.</p>
<p>We can fit a seasonal naive model using the <code>SNAIVE()</code> function in the <code>fable</code> package. The syntax of <code>model()</code> allows us to fit multiple models at once, so we can estimate the decomposition-based forecast and the seasonal naive benchmark in one step.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>fit_bench <span class="ot">&lt;-</span> train <span class="sc">|&gt;</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">model</span>(</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">stlf =</span> <span class="fu">decomposition_model</span>(</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>      <span class="fu">STL</span>(visits <span class="sc">~</span> <span class="fu">trend</span>(<span class="at">window =</span> <span class="dv">13</span>), <span class="at">robust =</span> <span class="cn">TRUE</span>),</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>      <span class="fu">ETS</span>(season_adjust)</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">snaive_bench =</span> <span class="fu">SNAIVE</span>(visits <span class="sc">~</span> <span class="fu">lag</span>(<span class="st">"year"</span>))</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>fc_bench <span class="ot">&lt;-</span> fit_bench <span class="sc">|&gt;</span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">forecast</span>(<span class="at">h =</span> h)</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a><span class="fu">accuracy</span>(fc_bench, test) <span class="sc">%&gt;%</span></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(.model, MAE, RMSE, MAPE)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Adapt the plot code above to plot the decomposition-based forecast and the seasonal naive benchmark on the same graph with the test data if you want to visualize the comparison.</p>
<div class="callout-attention">
<p><strong>Question 6:</strong> Which forecast performed better: the decomposition-based forecast or seasonal naive? Answer in your notebook.</p>
</div>
<hr>
</section>
<section id="section-7-replicate-the-process-for-another-park" class="level1">
<h1>Section 7: Replicate the process for another park</h1>
<p>Choose another park from the IRMA portal and repeat the process. You can use the same code as a template, but make sure to adjust it for the new data (e.g., variable names, date parsing).</p>
<div class="callout-attention">
<p><strong>Question 7:</strong></p>
<ul>
<li>Describe the new park’s visitation series. How does it compare to Arches NP in terms of trend, seasonality, and shocks?</li>
<li>How did the forecasting process go for the new park? Did you encounter any new challenges?</li>
<li>How did the forecast accuracy compare to Arches NP?</li>
</ul>
<p>Answer in your notebook.</p>
</div>
<hr>
</section>
<section id="deliverables" class="level1">
<h1>Deliverables</h1>
<p>Submit on Canvas:</p>
<ol type="1">
<li><p><strong>log file (<code>lab_forecasting_dsci.log</code>)</strong> Use the sink-source-sink pattern. Your log should include code + comments explaining each step.</p></li>
<li><p><strong>Lab notebook</strong> with answers to Questions 1–6.</p></li>
<li><p><strong>One figure</strong> (exported image or screenshot) showing:</p>
<ul>
<li>your STL decomposition plot <strong>or</strong></li>
<li>your final forecast plot with the holdout period visible</li>
</ul></li>
</ol>

</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" role="list">
<div id="ref-hyndman2018fpp3" class="csl-entry" role="listitem">
Hyndman, Rob J., and George Athanasopoulos. 2018. <em>Forecasting: Principles and Practice</em>. 3rd ed. OTexts. <a href="https://otexts.com/fpp3/">https://otexts.com/fpp3/</a>.
</div>
</div></section></div></main>
<!-- /main column -->
<footer class="course-footer">
  <div class="course-footer__inner">
    <a href="https://jbayham.github.io/arec-330/">← Back to course site</a>
    <span class="course-footer__sep">·</span>
    <a href="https://colostate.instructure.com/courses/218386" target="_blank" rel="noopener">Open Canvas</a>
  </div>
</footer>
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>