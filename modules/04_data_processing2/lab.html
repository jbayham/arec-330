<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Week 4 Lab: Data Processing (Part 2) - Merging Datasets</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="lab_files/libs/clipboard/clipboard.min.js"></script>
<script src="lab_files/libs/quarto-html/quarto.js"></script>
<script src="lab_files/libs/quarto-html/popper.min.js"></script>
<script src="lab_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="lab_files/libs/quarto-html/anchor.min.js"></script>
<link href="lab_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="lab_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="lab_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="lab_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="lab_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">


<link rel="stylesheet" href="../course-links.css">
</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#learning-objectives" id="toc-learning-objectives" class="nav-link active" data-scroll-target="#learning-objectives">Learning Objectives</a></li>
  <li><a href="#preliminaries" id="toc-preliminaries" class="nav-link" data-scroll-target="#preliminaries">Preliminaries</a>
  <ul class="collapse">
  <li><a href="#lab-notebook" id="toc-lab-notebook" class="nav-link" data-scroll-target="#lab-notebook">Lab Notebook</a></li>
  </ul></li>
  <li><a href="#section-1-recap-and-data-preparation" id="toc-section-1-recap-and-data-preparation" class="nav-link" data-scroll-target="#section-1-recap-and-data-preparation">Section 1: Recap and Data Preparation</a>
  <ul class="collapse">
  <li><a href="#context" id="toc-context" class="nav-link" data-scroll-target="#context">Context</a></li>
  <li><a href="#data" id="toc-data" class="nav-link" data-scroll-target="#data">Data</a></li>
  <li><a href="#task-1.1-load-and-inspect-the-bea-data" id="toc-task-1.1-load-and-inspect-the-bea-data" class="nav-link" data-scroll-target="#task-1.1-load-and-inspect-the-bea-data">Task 1.1: Load and Inspect the BEA Data</a></li>
  <li><a href="#task-1.2-reshape-bea-data-from-wide-to-long-format" id="toc-task-1.2-reshape-bea-data-from-wide-to-long-format" class="nav-link" data-scroll-target="#task-1.2-reshape-bea-data-from-wide-to-long-format">Task 1.2: Reshape BEA Data from Wide to Long Format</a></li>
  <li><a href="#task-1.3-clean-and-select-relevant-variables" id="toc-task-1.3-clean-and-select-relevant-variables" class="nav-link" data-scroll-target="#task-1.3-clean-and-select-relevant-variables">Task 1.3: Clean and Select Relevant Variables</a></li>
  </ul></li>
  <li><a href="#section-2-preparing-corn-yield-and-drought-data" id="toc-section-2-preparing-corn-yield-and-drought-data" class="nav-link" data-scroll-target="#section-2-preparing-corn-yield-and-drought-data">Section 2: Preparing Corn Yield and Drought Data</a>
  <ul class="collapse">
  <li><a href="#task-2.1-load-and-prepare-corn-yield-data" id="toc-task-2.1-load-and-prepare-corn-yield-data" class="nav-link" data-scroll-target="#task-2.1-load-and-prepare-corn-yield-data">Task 2.1: Load and Prepare Corn Yield Data</a></li>
  <li><a href="#task-2.2-load-and-prepare-drought-data" id="toc-task-2.2-load-and-prepare-drought-data" class="nav-link" data-scroll-target="#task-2.2-load-and-prepare-drought-data">Task 2.2: Load and Prepare Drought Data</a></li>
  </ul></li>
  <li><a href="#section-3-understanding-joins" id="toc-section-3-understanding-joins" class="nav-link" data-scroll-target="#section-3-understanding-joins">Section 3: Understanding Joins</a>
  <ul class="collapse">
  <li><a href="#types-of-joins" id="toc-types-of-joins" class="nav-link" data-scroll-target="#types-of-joins">Types of Joins</a>
  <ul class="collapse">
  <li><a href="#left-join" id="toc-left-join" class="nav-link" data-scroll-target="#left-join">Left Join</a></li>
  <li><a href="#inner-join" id="toc-inner-join" class="nav-link" data-scroll-target="#inner-join">Inner Join</a></li>
  <li><a href="#right-join" id="toc-right-join" class="nav-link" data-scroll-target="#right-join">Right Join</a></li>
  <li><a href="#full-join-outer-join" id="toc-full-join-outer-join" class="nav-link" data-scroll-target="#full-join-outer-join">Full Join (Outer Join)</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#section-4-merging-the-datasets" id="toc-section-4-merging-the-datasets" class="nav-link" data-scroll-target="#section-4-merging-the-datasets">Section 4: Merging the Datasets</a>
  <ul class="collapse">
  <li><a href="#task-4.1-merge-corn-yield-and-drought-data" id="toc-task-4.1-merge-corn-yield-and-drought-data" class="nav-link" data-scroll-target="#task-4.1-merge-corn-yield-and-drought-data">Task 4.1: Merge Corn Yield and Drought Data</a></li>
  <li><a href="#task-4.2-validate-the-first-merge" id="toc-task-4.2-validate-the-first-merge" class="nav-link" data-scroll-target="#task-4.2-validate-the-first-merge">Task 4.2: Validate the First Merge</a></li>
  <li><a href="#task-4.3-merge-with-bea-farm-gdp-data" id="toc-task-4.3-merge-with-bea-farm-gdp-data" class="nav-link" data-scroll-target="#task-4.3-merge-with-bea-farm-gdp-data">Task 4.3: Merge with BEA Farm GDP Data</a></li>
  <li><a href="#task-4.4-inspect-missing-values" id="toc-task-4.4-inspect-missing-values" class="nav-link" data-scroll-target="#task-4.4-inspect-missing-values">Task 4.4: Inspect Missing Values</a></li>
  <li><a href="#task-4.5-create-a-complete-cases-dataset" id="toc-task-4.5-create-a-complete-cases-dataset" class="nav-link" data-scroll-target="#task-4.5-create-a-complete-cases-dataset">Task 4.5: Create a Complete Cases Dataset</a></li>
  <li><a href="#task-4.6-export-the-final-dataset" id="toc-task-4.6-export-the-final-dataset" class="nav-link" data-scroll-target="#task-4.6-export-the-final-dataset">Task 4.6: Export the Final Dataset</a></li>
  </ul></li>
  <li><a href="#deliverables" id="toc-deliverables" class="nav-link" data-scroll-target="#deliverables">Deliverables</a></li>
  </ul>
</nav>
</div>
<main class="content" id="quarto-document-content">
<nav class="course-links" aria-label="Course links">
  <div class="course-links__inner">
    <div class="course-links__left">
      <a class="course-links__brand" href="https://jbayham.github.io/arec-330/">AREC 330</a>
      <span class="course-links__sep">|</span>
      <span class="course-links__page">Lab</span>
    </div>

    <div class="course-links__right">
      <a class="course-links__btn" href="https://jbayham.github.io/arec-330/">Course site</a>
      <a class="course-links__btn" href="https://colostate.instructure.com/courses/218386">Canvas</a>
    </div>
  </div>
</nav>

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Week 4 Lab: Data Processing (Part 2) - Merging Datasets</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<p><img src="includes/lab_header.png" class="img-fluid"></p>
<p>This lab builds on last week’s data processing work by introducing you to <strong>merging datasets</strong>—a critical skill for combining information from multiple sources. You’ll start with a recap of cleaning and preparing the BEA farm GDP data, then merge it with the corn yield and drought datasets you worked with in Lab 3. By the end, you’ll have a unified dataset ready for analysis.</p>
<section id="learning-objectives" class="level2">
<h2 class="anchored" data-anchor-id="learning-objectives">Learning Objectives</h2>
<p>By the end of the lab, you will be able to:</p>
<ul>
<li>Understand different types of joins (<code>left_join</code>, <code>inner_join</code>) and when to use each</li>
<li>Merge multiple datasets based on common key variables</li>
<li>Diagnose and troubleshoot merge issues (mismatched keys, duplicate rows)</li>
<li>Validate the integrity of merged data</li>
<li>Create a final analytical dataset combining economic, agricultural, and drought data</li>
</ul>
</section>
<section id="preliminaries" class="level2">
<h2 class="anchored" data-anchor-id="preliminaries">Preliminaries</h2>
<ol type="1">
<li>Create a folder called <code>lab_04</code> and navigate there in RStudio.</li>
<li>Create a new R script called <code>lab_04.R</code> in your <code>lab_04</code> folder.</li>
<li>Write a brief comment at the top describing the purpose of the script and your name.</li>
<li>Load required libraries at the top:</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lubridate)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="lab-notebook" class="level3">
<h3 class="anchored" data-anchor-id="lab-notebook">Lab Notebook</h3>
<p>Open up a word processing document (e.g., Google Doc, Word, or plain text) to serve as your lab notebook. Use this to respond to questions, document decisions, and reflect on the process. You should also comment your R script thoroughly to explain your code and rationale for each step.</p>
<hr>
</section>
</section>
<section id="section-1-recap-and-data-preparation" class="level1">
<h1>Section 1: Recap and Data Preparation</h1>
<section id="context" class="level2">
<h2 class="anchored" data-anchor-id="context">Context</h2>
<p>Last week, you worked with corn yield and drought data, learning to handle missing values, reshape untidy data, and aggregate time-series observations. This week, we’re adding a third dataset: <strong><a href="includes/BEA_farm_gdp.csv">Farm GDP</a> from the Bureau of Economic Analysis (BEA)</strong>.</p>
<p>The BEA data measures the economic value of agricultural production by state and year. Merging farm GDP with yield and drought data will let you explore questions like: <em>How does drought affect not just crop yields, but also farm economic output?</em></p>
<p>But first, we need to prepare the BEA data for merging. Real datasets rarely arrive in analysis-ready form, and the BEA data is no exception - it’s in “wide” format with years as columns.</p>
</section>
<section id="data" class="level2">
<h2 class="anchored" data-anchor-id="data">Data</h2>
<p>The file <a href="includes/BEA_farm_gdp_2000-2024.csv">BEA_farm_gdp_2000-2024.csv</a> contains farm GDP (in millions of current dollars) for each state from 2000 to 2024. Download it or load it directly from the course repository.</p>
</section>
<section id="task-1.1-load-and-inspect-the-bea-data" class="level2">
<h2 class="anchored" data-anchor-id="task-1.1-load-and-inspect-the-bea-data">Task 1.1: Load and Inspect the BEA Data</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Read the BEA farm GDP data</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>bea_raw <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"https://jbayham.github.io/arec-330/modules/04_data_processing2/includes/BEA_farm_gdp_2000-2024.csv"</span>)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Inspect the structure</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(bea_raw)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout-attention">
<p>Question 1: What makes this data “untidy”? How many columns represent years? What challenges does this structure create for merging with other datasets? Answer in your notebook.</p>
</div>
</section>
<section id="task-1.2-reshape-bea-data-from-wide-to-long-format" class="level2">
<h2 class="anchored" data-anchor-id="task-1.2-reshape-bea-data-from-wide-to-long-format">Task 1.2: Reshape BEA Data from Wide to Long Format</h2>
<p>To merge with our corn yield and drought data (which are in tidy, long format with one row per state-year), we need to pivot the BEA data from wide to long. Name the new year column <code>year</code> and the farm GDP column <code>farm_gdp</code>.</p>
</section>
<section id="task-1.3-clean-and-select-relevant-variables" class="level2">
<h2 class="anchored" data-anchor-id="task-1.3-clean-and-select-relevant-variables">Task 1.3: Clean and Select Relevant Variables</h2>
<p>There are a few columns that we need to modify to make them compatible with our other datasets. First, we need to ensure the <code>year</code> variable is numeric (not character) for merging. Use the function <code>as.numeric()</code> to convert the year column. Think about the <code>dplyr</code> verb you would use to transform the year variable. Second, the column <code>CL_UNIT</code> indicates that the values are in millions of dollars, but we want to convert them to actual dollars for easier interpretation. Use the appropriate <code>dplyr</code> verb to create a new column <code>farm_gdp</code> that contains the farm GDP in dollars (not millions).</p>
<div class="callout-attention">
<p>Question 2: Why is it important to convert <code>year</code> to numeric before merging? What problems might arise if we left it as a character variable? Answer in your notebook.</p>
</div>
<p>The BEA data has several columns we don’t need for our analysis. Keep only the following columns:</p>
<ul>
<li><code>state_abr</code> (state abbreviation)</li>
<li><code>year</code> (after conversion to numeric)</li>
<li><code>farm_gdp</code> (after conversion to dollars)</li>
</ul>
<p>Ensure the final dataset is called <code>bea_final</code> and is in tidy format with one row per state-year.</p>
<hr>
</section>
</section>
<section id="section-2-preparing-corn-yield-and-drought-data" class="level1">
<h1>Section 2: Preparing Corn Yield and Drought Data</h1>
<p>Before we can merge all three datasets, we need to load and prepare the corn yield and drought data from last week. This is a quick recap to ensure everyone starts from the same place.</p>
<section id="task-2.1-load-and-prepare-corn-yield-data" class="level2">
<h2 class="anchored" data-anchor-id="task-2.1-load-and-prepare-corn-yield-data">Task 2.1: Load and Prepare Corn Yield Data</h2>
<p>Read in the corn yield data <a href="../03_data_processing/includes/corn_yield_2000-2025.csv">corn_yield_2000-2025.csv</a>. Select only the relevant columns (<code>state_alpha</code>, <code>year</code>, and <code>Value</code>), and rename <code>Value</code> to <code>yield_bu_per_acre</code> for clarity. The <code>dplyr</code> function <code>rename()</code> allows you to change the name of a column. The syntax is <code>rename(new_name = old_name)</code>. Use this function to rename the <code>Value</code> column to <code>yield_bu_per_acre</code>. Store the cleaned dataset in a new object called <code>corn_clean</code>.</p>
</section>
<section id="task-2.2-load-and-prepare-drought-data" class="level2">
<h2 class="anchored" data-anchor-id="task-2.2-load-and-prepare-drought-data">Task 2.2: Load and Prepare Drought Data</h2>
<p>Recall from last week that we calculated the Drought Severity Composite Index (DSCI) and aggregated weekly drought data to annual values. Either load the processed drought data from last week or repeat the steps to calculate DSCI and aggregate to annual level. The key variables to keep are <code>StateAbbreviation</code>, <code>year</code>, and <code>mean_dsci</code> (the average DSCI for each state-year). Call the resulting dataset <code>drought_annual</code>.</p>
<div class="callout-attention">
<p>Question 3: Before proceeding to merging, identify the key variables in each dataset that we’ll use to match rows across datasets. What variables do all three datasets have in common? Answer in your notebook.</p>
</div>
<hr>
</section>
</section>
<section id="section-3-understanding-joins" class="level1">
<h1>Section 3: Understanding Joins</h1>
<p>Before merging our datasets, we need to understand <strong>different types of joins</strong> and when to use each one. Joins combine datasets based on shared “key” variables.</p>
<section id="types-of-joins" class="level2">
<h2 class="anchored" data-anchor-id="types-of-joins">Types of Joins</h2>
<section id="left-join" class="level3">
<h3 class="anchored" data-anchor-id="left-join">Left Join</h3>
<ul>
<li><strong>What it does:</strong> Keeps all rows from the “left” (first) dataset and adds matching rows from the “right” (second) dataset.</li>
<li><strong>When to use:</strong> When you want to preserve all observations from your primary dataset, even if they don’t have matches in the secondary dataset.</li>
<li><strong>Result:</strong> Rows from the left dataset without matches will have <code>NA</code> values for variables from the right dataset.</li>
</ul>
</section>
<section id="inner-join" class="level3">
<h3 class="anchored" data-anchor-id="inner-join">Inner Join</h3>
<ul>
<li><strong>What it does:</strong> Keeps only rows that have matches in both datasets.</li>
<li><strong>When to use:</strong> When you only want complete cases where data exists in both sources.</li>
<li><strong>Result:</strong> Smaller dataset; only observations present in both datasets are retained.</li>
</ul>
</section>
<section id="right-join" class="level3">
<h3 class="anchored" data-anchor-id="right-join">Right Join</h3>
<ul>
<li><strong>What it does:</strong> Opposite of left join. It keeps all rows from the right dataset.</li>
<li><strong>When to use:</strong> Less common; usually you can rearrange datasets and use left join instead.</li>
</ul>
</section>
<section id="full-join-outer-join" class="level3">
<h3 class="anchored" data-anchor-id="full-join-outer-join">Full Join (Outer Join)</h3>
<ul>
<li><strong>What it does:</strong> Keeps all rows from both datasets, filling in <code>NA</code> where matches don’t exist.</li>
<li><strong>When to use:</strong> When you want the complete picture and don’t want to lose any observations.</li>
</ul>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="includes/joins.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Join Types Visualization</figcaption>
</figure>
</div>
<div class="callout-attention">
<p>Question 4: Suppose you have state-year corn yield data (2000-2025, all states) and you merge it with BEA farm GDP data (1997-2024, all states). If you use a <strong>left join</strong> with corn yield as the left dataset, what will happen to years before 2000 in the BEA data? What about years 2000-2024? Answer in your notebook.</p>
</div>
<hr>
</section>
</section>
</section>
<section id="section-4-merging-the-datasets" class="level1">
<h1>Section 4: Merging the Datasets</h1>
<p>Now we’re ready to combine our three datasets. We’ll merge step by step, validating each merge before proceeding to the next.</p>
<section id="task-4.1-merge-corn-yield-and-drought-data" class="level2">
<h2 class="anchored" data-anchor-id="task-4.1-merge-corn-yield-and-drought-data">Task 4.1: Merge Corn Yield and Drought Data</h2>
<p>First, let’s merge corn yield with drought data. Notice that the state abbreviation variable has different names in each dataset: <code>state_alpha</code> in corn data and <code>StateAbbreviation</code> in drought data. The <code>by</code> argument in join functions allows you to specify how to match variables with different names. The syntax is <code>by = c("left_var" = "right_var")</code>. Use this syntax to specify the correct matching variables for the merge. If the left and right datasets have columns with the same name that you want to match on, you can simply use <code>by = "variable_name"</code> without needing to specify the left and right variable names separately.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># First merge: corn yield + drought</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Use inner_join to keep only states/years present in both datasets</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>corn_drought <span class="ot">&lt;-</span> <span class="fu">inner_join</span>(</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>  corn_clean,</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>  drought_annual,</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"state_alpha"</span> <span class="ot">=</span> <span class="st">"StateAbbreviation"</span>, <span class="st">"year"</span> <span class="ot">=</span> <span class="st">"year"</span>)</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Inspect the result</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(corn_drought)</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(corn_drought, <span class="dv">10</span>)</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Check dimensions</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Corn rows:"</span>, <span class="fu">nrow</span>(corn_clean), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Drought rows:"</span>, <span class="fu">nrow</span>(drought_annual), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Merged rows:"</span>, <span class="fu">nrow</span>(corn_drought), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout-attention">
<p>Question 5: How many observations are in the merged <code>corn_drought</code> dataset? Did we lose any observations compared to the original corn yield dataset? Why or why not? (Hint: Think about which states grow corn vs.&nbsp;which states have drought data.) Answer in your notebook.</p>
</div>
</section>
<section id="task-4.2-validate-the-first-merge" class="level2">
<h2 class="anchored" data-anchor-id="task-4.2-validate-the-first-merge">Task 4.2: Validate the First Merge</h2>
<p>Before proceeding, let’s check for any issues:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Check for missing values in key variables</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(corn_drought)</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Verify no duplicate state-year combinations</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>corn_drought <span class="sc">%&gt;%</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(state_alpha, year) <span class="sc">%&gt;%</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(n <span class="sc">&gt;</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout-attention">
<p>Question 6: What would it mean if we found duplicate state-year combinations? What problems could this cause for analysis? Answer in your notebook.</p>
</div>
</section>
<section id="task-4.3-merge-with-bea-farm-gdp-data" class="level2">
<h2 class="anchored" data-anchor-id="task-4.3-merge-with-bea-farm-gdp-data">Task 4.3: Merge with BEA Farm GDP Data</h2>
<p>Now let’s add the BEA farm GDP data to our corn-drought dataset.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Second merge: add BEA farm GDP</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Use left_join to keep all corn-drought observations</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="co"># and match BEA data where available</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>final_data <span class="ot">&lt;-</span> <span class="fu">left_join</span>(</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>  corn_drought,</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>  bea_final,</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"state_alpha"</span> <span class="ot">=</span> <span class="st">"state_abr"</span>, <span class="st">"year"</span> <span class="ot">=</span> <span class="st">"year"</span>)</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Inspect the result</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(final_data)</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(final_data, <span class="dv">15</span>)</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Check dimensions</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Corn-drought rows:"</span>, <span class="fu">nrow</span>(corn_drought), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"BEA rows:"</span>, <span class="fu">nrow</span>(bea_final), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Final merged rows:"</span>, <span class="fu">nrow</span>(final_data), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout-attention">
<p>Question 7: Why did we use <code>left_join()</code> for this merge instead of <code>inner_join()</code>? What would happen if we had used <code>inner_join()</code>? Answer in your notebook.</p>
</div>
</section>
<section id="task-4.4-inspect-missing-values" class="level2">
<h2 class="anchored" data-anchor-id="task-4.4-inspect-missing-values">Task 4.4: Inspect Missing Values</h2>
<p>Let’s check for missing farm GDP values, which might indicate states in our corn-drought data that don’t have matching BEA data.</p>
<hr>
</section>
<section id="task-4.5-create-a-complete-cases-dataset" class="level2">
<h2 class="anchored" data-anchor-id="task-4.5-create-a-complete-cases-dataset">Task 4.5: Create a Complete Cases Dataset</h2>
<p>For some analyses, you might want a dataset with no missing values. Let’s create a “complete cases” version. We will use the <code>filter()</code> function to keep only rows where <code>yield_bu_per_acre</code>, <code>mean_dsci</code>, and <code>farm_gdp</code> are not missing. The syntax is <code>filter(!is.na(variable_name))</code>. Use this syntax to filter out rows with missing values in the key variables. The <code>!</code> operator negates the condition, so <code>!is.na(variable_name)</code> keeps rows where the variable is not missing. Store this complete cases dataset in an object called <code>final_data_complete</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Remove rows with any missing values</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>final_data_complete <span class="ot">&lt;-</span> final_data <span class="sc">%&gt;%</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(yield_bu_per_acre), </span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>         <span class="sc">!</span><span class="fu">is.na</span>(mean_dsci), </span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>         <span class="sc">!</span><span class="fu">is.na</span>(farm_gdp))</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare dimensions</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Full dataset:"</span>, <span class="fu">nrow</span>(final_data), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Complete cases:"</span>, <span class="fu">nrow</span>(final_data_complete), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Removed:"</span>, <span class="fu">nrow</span>(final_data) <span class="sc">-</span> <span class="fu">nrow</span>(final_data_complete), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="task-4.6-export-the-final-dataset" class="level2">
<h2 class="anchored" data-anchor-id="task-4.6-export-the-final-dataset">Task 4.6: Export the Final Dataset</h2>
<p>Save your merged dataset for future analysis.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Export to CSV</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="fu">write_csv</span>(final_data, <span class="st">"corn_drought_gdp_full.csv"</span>)</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="fu">write_csv</span>(final_data_complete, <span class="st">"corn_drought_gdp_complete.csv"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout-attention">
<p>Question 8: Explain how the question we posed initially guided out data processing and merging decisions. Now that we have a merged dataset, what types of analyses could we conduct to explore the relationship between drought, corn yield, and farm GDP? Answer in your notebook.</p>
</div>
<hr>
</section>
</section>
<section id="deliverables" class="level1">
<h1>Deliverables</h1>
<p>Submit the following on Canvas:</p>
<ol type="1">
<li><p><strong>log file (<code>lab_04.log</code>):</strong> Organize your code and make sure it runs without errors. Generate a log file called <code>lab_04.log</code> using the sink-source-sink pattern from previous labs. The log file should include all the code you wrote for this lab, along with comments explaining each step.</p></li>
<li><p><strong>Lab Notebook:</strong> Compile your answers to all 8 questions in a single document (e.g., Google Doc, Word, or PDF). Make sure to clearly label each question and provide thoughtful, detailed responses based on your analysis.</p></li>
</ol>
</section>

</main>
<!-- /main column -->
<footer class="course-footer">
  <div class="course-footer__inner">
    <a href="https://jbayham.github.io/arec-330/">← Back to course site</a>
    <span class="course-footer__sep">·</span>
    <a href="https://colostate.instructure.com/courses/218386" target="_blank" rel="noopener">Open Canvas</a>
  </div>
</footer>
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>