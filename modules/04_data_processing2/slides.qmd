---
title: "Week 4: Joining and Merging Data"
format:
  revealjs:
    slide-number: true
    theme: [night, ../custom.scss]
    touch: true
---

## Big Picture: <br>Corn Yield and Drought

<br>
```{mermaid}
%%{init: {"themeVariables": {"fontSize": "24px"}}}%%
flowchart LR
  G[Goals] ==> P[Problem]
  P ==> Q[Question]
  Q ==> Da[Data]
  Da ==> M[Model]
  M ==> R[Result]
  R ==> D[Decision]
```

<br>

- What is the USDA's goal?

- Problem?

- Question?


##  {.iclicker}

:::{.question}
You have county-year yield data, but weather data are monthly. What should you do before merging?
:::

:::{.choices}
A. Drop the weather data because it is higher frequency.  
B. Aggregate weather to the county-year level to match the unit of observation.   
C. Duplicate yield rows to match each month.  
D. Convert yield to monthly values by dividing by 12. 
:::

:::{.notes}
B
:::

##  {.iclicker}

:::{.question}
Which handling of missing values preserves information about missingness itself?
:::

:::{.choices}
A. Dropping all rows with any missing values.
B. Replacing missing values with zero.
C. Creating a missingness indicator or category.
D. Replacing missing values with the mean.
:::

:::{.notes}
C
:::


## Motivation: Why Joins Matter

- Deep insights often come from combining datasets
- Errors are hard to detect after models run
- Joins can create bias by selection or duplication

::: {.notes}
Examples from research:
- County-level yield + drought index
- Wildfires and recreation outcomes 
- Wildfires and water quality
:::

## Unit of Observation 

- Let the analytic question define the unit of observation
- All joins should preserve the target unit
- Example target unit: county-year

::: {.notes}
Ask: "What is a row supposed to represent?" 
:::


## Primary and Compound Keys

- Keys define how tables relate to each other - a concept from relational databases
- Primary key: unique ID for each row
- Compound key: multiple columns define uniqueness



##  {.iclicker}

:::{.question}
What variables make up the compound key in our corn yield and drought example in lab?
:::

:::{.choices}
A. state and year  
B. county and year  
C. year only  
D. state only 
:::

:::{.notes}
A 
:::



## Joins

<div style="text-align:center">
  <img src="includes/joins.png" style="max-width:50%;height:auto;margin:0 auto;" />
</div>

- `left_join()`: keep all rows in left table
- `inner_join()`: keep only matched rows
- `right_join()`/`full_join()`: mostly for debugging


::: {.notes}
Stress: join type is a policy decision about who stays in sample.
:::


## Example

::::{.columns}

:::{.column}
| state   | year | yield |
| ------- | ---: | ----: |
| A       | 2020 |   120 |
| B       | 2020 |    95 |
| C       | 2020 |   105 |
:::

:::{.column}
| state   | year | drought |
| :------- | ---: | ------: |
| A       | 2020 |     0.8 |
| D       | 2020 |     0.6 |
:::

::::
<br>
What would an inner join create?

## Example: Inner Join
| state   | year | yield | drought |
| ------- | ---: | ----: | ------: |
| A       | 2020 |   120 |     0.8 |

<br> 

Only state A appears because it's the only match.

## Example

::::{.columns}

:::{.column}
| state   | year | yield |
| ------- | ---: | ----: |
| A       | 2020 |   120 |
| B       | 2020 |    95 |
| C       | 2020 |   105 |
:::

:::{.column}
| state   | year | drought |
| :------- | ---: | ------: |
| A       | 2020 |     0.8 |
| D       | 2020 |     0.6 |
:::

::::
<br>
What would an left join create?


## Example: Left Join
| state   | year | yield | drought |
| ------- | ---: | ----: | ------: |
| A       | 2020 |   120 |     0.8 |
| B       | 2020 |    95 |     NA |
| C       | 2020 |   105 |     NA |

<br>
All yield with drought data for matches

## Example

::::{.columns}

:::{.column}
| state   | year | yield |
| ------- | ---: | ----: |
| A       | 2020 |   120 |
| B       | 2020 |    95 |
| C       | 2020 |   105 |
:::

:::{.column}
| state   | year | drought |
| :------- | ---: | ------: |
| A       | 2020 |     0.8 |
| D       | 2020 |     0.6 |
:::

::::
<br>
What would an full join create?


## Example: Full Join
| state   | year | yield | drought |
| ------- | ---: | ----: | ------: |
| A       | 2020 |   120 |     0.8 |
| B       | 2020 |    95 |     NA |
| C       | 2020 |   105 |     NA |
| D       | 2020 |   NA  |    0.6 |

<br>
All data from both with drought data for matches

## Implicit Assumptions in Joins

- Keys are correctly defined and formatted
- Any observations dropped by inner join are ignorable or acknowledged
- The measurements in each dataset are compatible


## Diagnostics Before the Join

- Confirm unit and key definitions
- Check key uniqueness on both tables
- Check overlap and missing keys
- Predict expected row counts

::: {.notes}
Say: if any step fails, stop and investigate.
:::


## Common Issues

- Many-to-many joins inflate rows
- Key mismatches (types, formatting, leading zeros)
- Temporal mismatch or look-ahead bias
- Unintended selection via inner join

::: {.notes}
Highlight FIPS as classic leading-zero issue.
:::

## Summary: Joining & Merging Data{.scrollable}

- **Unit of observation:** Define the row (e.g., county-year) and match datasets to it.
- **Keys:** Use correct primary or compound keys; verify uniqueness and formatting.
- **Join type is policy:** `left_join()` preserves your target sample; `inner_join()` restricts to matches; `full_join()` shows all records.
- **Diagnostics:** Compare row counts, check overlaps, detect many-to-many inflations, and inspect duplicated rows.
- **Pre-merge step:** Aggregate or transform higher-frequency data (e.g., monthly â†’ county-year) before joining.


## [Project](../../project/)

- Groups of 3
- Find a real world decision that could be informed by data
- Who is the decision maker? 
- What is their goal/objective? 
- What is the problem they face?
- What is the question they need answered?

```{mermaid}
%%{init: {"themeVariables": {"fontSize": "24px"}}}%%
flowchart LR
  G[Goals] ==> P[Problem]
  P ==> Q[Question]
  Q ==> Da[Data]
  Da ==> M[Model]
  M ==> R[Result]
  R ==> D[Decision]
```
